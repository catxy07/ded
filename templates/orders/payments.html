{% extends 'base.html' %}
{% load static %}
{% block content %}

<section class="section-content padding-y bg">
<div class="container">

<h4 class="text-center mb-4">Review Your Order and Make Payment</h4>

<div class="row">
    <!-- LEFT SIDE -->
	<aside class="col-lg-8">

    <!-- Billing Address -->
    <div class="card mb-3">
        <h5 class="card-header">Billing Address</h5>
        <div class="card-body">
            <p class="mb-0">{{ order.full_name }}</p>
            <p class="mb-0">{{ order.full_address }}</p>
            <p class="mb-0">{{ order.city }}, {{ order.state }}</p>
            <p class="mb-0">{{ order.country }}</p>
            <p class="mb-0">{{ order.email }}</p>
            <p class="mb-0">{{ order.phone }}</p>
            {% if order.order_note %}
                <b>Order Note:</b> {{ order.order_note }}
            {% endif %}
        </div>
    </div>

    <!-- Payment Method -->
    <div class="card mb-3">
        <h5 class="card-header">Payment Method</h5>
        <div class="card-body">
            <p class="card-text">Razorpay</p>
        </div>
    </div>

    <!-- Review Products -->
    <div class="card">
        <h5 class="card-header">Review Products</h5>
        <div class="card-body">
            <table class="table table-borderless">
                <thead class="text-muted">
                    <tr>
                        <th>Product</th>
                        <th width="120">Qty</th>
                        <th width="120">Price</th>
                    </tr>
                </thead>
                <tbody>
                {% for cart_item in cart_items %}
                    <tr>
                        <td>
                            <figure class="itemside align-items-center">
                                <div class="aside">
                                    <img src="{{ cart_item.product.images.url }}" class="img-sm">
                                </div>
                                <figcaption class="info">
                                    <a href="{{ cart_item.product.get_url }}" class="title text-dark">
                                        {{ cart_item.product.product_name }}
                                    </a>
                                    <p class="text-muted small">
                                        {% for item in cart_item.variations.all %}
                                            {{ item.variation_category|capfirst }} :
                                            {{ item.variation_value|capfirst }} <br>
                                        {% endfor %}
                                    </p>
                                </figcaption>
                            </figure>
                        </td>
                        <td>{{ cart_item.quantity }}</td>
                        <td>
                            <strong>{{ cart_item.sub_total }}</strong><br>
                            <small class="text-muted">{{ cart_item.product.price }} each</small>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

	</aside>

    <!-- RIGHT SIDE -->
	<aside class="col-lg-4">
		<div class="card">
		    <div class="card-body">
                <dl class="dlist-align">
                    <dt>Total:</dt>
                    <dd class="text-right">{{ total }}</dd>
                </dl>
                <dl class="dlist-align">
                    <dt>Tax:</dt>
                    <dd class="text-right">{{ tax }}</dd>
                </dl>
                <dl class="dlist-align">
                    <dt>Grand Total:</dt>
                    <dd class="text-right text-dark">
                        <strong>{{ grand_total }}</strong>
                    </dd>
                </dl>
                <hr>

                <button id="pay-btn" class="btn btn-primary btn-block">
                    Pay with Razorpay
                </button>
		    </div>
		</div>
	</aside>
</div>

</div>
</section>

<!-- RAZORPAY SCRIPT -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    var amount = "{{ grand_total }}";
    var razorpay_amount = parseInt(amount * 100); // paise
    var url = "{% url 'payments' %}";
    var csrftoken = getCookie('csrftoken');
    var orderID = "{{ order.order_number }}";
    var redirect_url = "{% url 'order_complete' %}";

    var options = {
        "key": "rzp_live_RPQOT0nooNjHJv",   // ðŸ”‘ TEST KEY
        "amount": razorpay_amount,
        "currency": "INR",
        "name": "GreatKart",
        "description": "Order Payment",
        "handler": function (response) {

            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
                },
                body: JSON.stringify({
                    orderID: orderID,
                    transID: response.razorpay_payment_id,
                    payment_method: "Razorpay",
                    status: "Success",
                }),
            })
            .then(res => res.json())
            .then(data => {
                window.location.href =
                    redirect_url +
                    "?order_number=" + data.order_number +
                    "&payment_id=" + data.transID;
            });
        }
    };

    var rzp1 = new Razorpay(options);

    document.getElementById("pay-btn").onclick = function (e) {
        rzp1.open();
        e.preventDefault();
    };
});
</script>

{% endblock %}
